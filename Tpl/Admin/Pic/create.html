<!DOCTYPE HTML>
<html>
<head>
    <include file="Tpl/Admin/default/header.inc.html"/>
</head>
<body class="metrouicss">
<include file="Tpl/Admin/default/top.inc.html"/>
<div id="main">
<include file="Tpl/Admin/default/nav.inc.html"/>
<div id="main-container">

<table width="100%" border="0" cellspacing="0" cellpadding="0" id="toolbar">
    <tr>
        <td>
            <p>您正在：{$crumbNav.action}&nbsp;&nbsp;{$crumbNav.module}</p>
        </td>
        <td><a href="javascript:;" onClick="history.back()">返回&gt;&gt;</a>
        </td>
    </tr>
</table>
    <!--<div id="classlist">-->
        <!--<h3>-->
            <!--频道分类-->
        <!--</h3>-->
        <!--<div>-->
            <!--<div class="left">-->
                <!--<div id="category_new"> <i class="icon-plus-2" id="category_new_btn"></i>   </div>-->
                <!--<ul id="categoryTree" class="ztree"></ul>-->
            <!--</div>-->
        <!--</div>-->
    <!--</div>-->

<div id="right">



<form enctype="multipart/form-data" method="post" action="__APP__/Admin/Pic/add" id="dataform">
<input type="hidden" name="id" value="{$product.id}" />
    <input type="hidden" id="iamgeId" name="type" value="1" />
    <input type="hidden" name="picture" id="picture" value="{$product.images}"/>
<ul class="accordion" data-role="accordion">
<li class="active"><a href="#" class="title">
    必填项
</a>
    <div>
        <table width="100%" border="0" cellspacing="0" cellpadding="0" class="cmsform">

            <tr>
                <th>名称：</th>
                <td class="form">
                    <div class="input-control text"><input name="pic_name" id="product_name" value="{$product.pic_name}"  type="text">
                    </div>
                </td>
                <td class="v" id="v_product_name"></td>
            </tr>
            <tr>
                <th>排序：</th>
                <td class="form">
                    <div class="input-control text"><input name="sort" id="sort" value="{$product.sort}"  type="text">
                    </div>
                </td>
                <td class="v" id="v_product_name"></td>
            </tr>

            <!--<tr>-->
                <!--<th>内容</th>-->
                <!--<td class="form">-->
                    <!--<script id="editor" type="text/plain" name="content" value="{$product.content}">-->
                    <!--{$product.content|htmlspecialchars_decode|stripslashes}-->
                <!--</script>-->
                <!--</td>-->
                <!--<td class="v" id="v_category_content"></td>-->

            <!--</tr>-->
            <tr>
                <th>上传图片</th>
                <td class="form"><input type="file" name="fileField" id="fileField" accept="image/*"></td>
                <td>&nbsp;</td>
            </tr>
            <tr>
                <th>&nbsp;</th>
                <td id="product_image">
                </td>
                <td>&nbsp;</td>
            </tr>
            <tr>
                <th>缩略图</th>
                <td class="form">
                    <if condition="$product.thumb neq null">
                        <img src="__APP__/{$product.thumb}" id="preview-img" />
                        <else />
                        <img src="" id="preview-img" />
                    </if>
                </td>
                <td>&nbsp;</td>
            </tr>

        </table>
    </div>
</li>
<li><a href="#" class="title">
    可选项
</a>
    <div> <table width="100%" border="0" cellspacing="0" cellpadding="0" class="cmsform">

        <if condition="$pageSwitch['keywords'] == 1">
            <tr>
                <th>备注</th>
                <td class="form">
                    <div class="input-control text"><input name="keywords" id="keywords" type="text" value="{$product.keywords}"></div>
                </td>
                <td>&nbsp;</td>
            </tr>
        </if>
        <if condition="$pageSwitch['description'] == 1">
            <tr>
                <th>简述</th>
                <td class="form">
                    <div class="input-control text"><textarea id="memo" name="memo" value="{$product.memo}"></textarea></div>
                </td>
                <td>&nbsp;</td>
            </tr>
        </if>
        <if condition="$pageSwitch['param'] == 1">
            <tr>
                <th>参数</th>
                <td class="form">
                    <textarea id="editorcs"  name="arguements"></textarea>
                </td>
                <td class="v"></td>
            </tr>
        </if>
        <if condition="$pageSwitch['attachment'] == 1">
            <tr>
                <th>上传附件</th>
                <td class="form"><input type="file" name="attachment" id="attachment"></td>
                <td>&nbsp;</td>
            </tr>
            <tr>
                <th>&nbsp;</th>
                <td id="attachment_url">
                    最大尺寸 2M 支持类型 .doc .docx .xls .xlsx .ppt .pptx .txt .zip .rar .7z .pdf
                </td>
                <td><input id="attachment_hidden" name="attachment_name" type="hidden" value="test"/>&nbsp;</td>
            </tr>
        </if>
        <if condition="$pageSwitch['brand'] == 1">
            <tr>
                <th>品牌</th>
                <td class="form">
                    <div class="input-control select"><select name="brand">
                        <option>---请选择品牌---</option>
                        <foreach name="product['brandList']" item="sub">
                            <option value ="{$key}">{$sub}</option>
                        </foreach>
                    </select></div>
                </td>
                <td>&nbsp;</td>
            </tr>
        </if>
        <if condition="$pageSwitch['marketprice'] == 1">
            <tr>
                <th>市场价格</th>
                <td class="form">
                    <div class="input-control text span2"><input name="market_price" id="market_price" type="text" value="{$product.market_price}"></div>
                </td>
                <td>&nbsp;</td>
            </tr>
        </if>
        <if condition="$pageSwitch['memberprice'] == 1">
            <tr>
                <th>会员价格</th>
                <td class="form">

                    <div class="input-control text span2"><input name="member_price" id="member_price" type="text" value="{$product.member_price}"></div>
                </td>
                <td>&nbsp;</td>
            </tr>
        </if>
        <if condition="$pageSwitch['target'] == 1">
            <tr>
                <th>标记</th>
                <td class="form">
                    <label onclick="" class="input-control radio"><input type="radio" value="1"
                                                                         name="mark" checked=""><span
                            class="helper"><img src="{$images_dir}/product/ico_free.png"></span></label>
                    <label onclick="" class="input-control radio"><input type="radio" name="mark"
                                                                         value="2"><span
                            class="helper"><img src="{$images_dir}/product/ico_gift.png"></span></label>
                    <label onclick="" class="input-control radio"><input type="radio" name="mark"
                                                                         value="3"><span
                            class="helper"><img src="{$images_dir}/product/ico_hot.png"></span></label>
                    <label onclick="" class="input-control radio"><input type="radio" name="mark"
                                                                         value="4"><span
                            class="helper"><img src="{$images_dir}/product/ico_new.png"></span></label>
                    <label onclick="" class="input-control radio"><input type="radio" name="mark"
                                                                         value="5"><span
                            class="helper"><img src="{$images_dir}/product/ico_recommend.png"></span></label>
                    <label onclick="" class="input-control radio"><input type="radio" name="mark"
                                                                         value="6"><span
                            class="helper"><img src="{$images_dir}/product/ico_quality.png"></span></label></td>
                <td>&nbsp;</td>
            </tr>
        </if>
        <if condition="$pageSwitch['status'] == 2">
            <tr>
                <th>上架</th>
                <td class="form"><label class="input-control switch" onClick="">
                    <input id="status" name="status" type="checkbox" checked=""/>
                    <span class="helper">&nbsp;</span>
                </label></td>
                <td>&nbsp;</td>
            </tr>
        </if>
        <if condition="$pageSwitch['ishot'] == 1">
            <tr>
                <th>是否推荐到主页</th>
                <td class="form"><label class="input-control switch" onClick="">
                    <if condition="$product['ishot'] == 1">
                        <input id="ishot" name="ishot" type="checkbox" checked="checked"/>
                        <span class="helper">&nbsp;</span>
                        <else />
                        <input id="ishot" name="ishot" type="checkbox"/>
                        <span class="helper">&nbsp;</span>
                    </if>

                </label></td>
                <td>&nbsp;</td>
            </tr>

        </if>
        <if condition="$pageSwitch['stock'] == 1">
            <tr>
                <th>库存</th>
                <td class="form">
                    <div class="input-control text span2"><input name="amount" id="amount" type="text"></div>
                </td>
                <td>&nbsp;</td>
            </tr>
        </if>

        <if condition="$pageSwitch['releasedate'] == 1">
            <tr>
                <th>发布日期</th>
                <td class="form">
                    <div class="input-control text span2">
                        <input name="create_date" id="datepicker" type="text" class="dateInput" value="" readonly>
                    </div>
                </td>
                <td>&nbsp;</td>
            </tr>
        </if>
    </table>
    </div>
</li>

</ul>

<div class="buttons">
    <input type="submit" value="确认">
    <input type="reset" value="重置">
    <input type="button" onclick="history.back()" value="取消"/>
</div>
</form>
</div>
<!--end.right-->
</div>
</div>
<!--end.main-->
<include file="Tpl/Admin/default/footer.inc.html"/>
<script type="text/javascript">

    var imageDefaultDir = "{$images_dir}/noimg.jpg";

    $(function () {
        categorySelectTree.init(2);
        categoryTree.init(2);
        //调用产品介绍编辑器
//        var contentEditor = beditor.new('editor','admin');
        //调用产品参数编辑器
        var argumentsEditor = null;
        if ( $('#argumentsEditor').length  != 0){
            var argumentsEditor =  beditor.new('editorcs','admin');
        }
        //日历控件调用
        datepicker.new('datepicker');

        category.init(2);
        // 修改为1.7以上的新绑定
        $(document).on('click','.preview-img',function(){
            $('#preview-img').attr('style','' );
            $('#preview-img').attr('src', $(this).attr('src'));
            $('#picture').val($(this).attr('src'));

            $("#iamgeId").val($(this).attr('id'));
            $('#imageSubmit').show();
            jcorp.renewApi();
        });

        $(document).on('click','.delImage',function(){
            $($(this).parent("span:first")).parent("span:first").remove();
            $('#preview-img').attr('src',imageDefaultDir );
            $('#preview-img').attr('style','width: 126px;height: 126px;' );
            $('#imageSubmit').hide();
            $("#iamgeId").val('');
            var hideId = "hide_" +$(this).attr('id').split("_")[1];
            $("#"+hideId).remove();
            jcorp.deleteApi();

        });



        $('#fileField').live('change', function () {
            ajaxFileUpload();
        })
        $('#attachment').live('change', function () {
            ajaxFileUploadAttachment();
        })

        //ICE 2013-11-07 改变分辨率时重新裁剪
        $('#ratio').change(function () {
            if ($('#preview-img').prop('src') != '')
                jcorp.renewApi();
        })


        var validator = $("#dataform").validate({
            rules: {
                product_name: "required",
                product_id: "required",
                category_name : "required",
                type:"required"
            },
            errorPlacement: function(error, element) {
                element.focus();
            },
            submitHandler: function (form) {
                contentEditor.sync();

                if ( $('#category_id').val() == null || $('#category_id').val() == ''){
                    $('#category_name').removeClass('valid').addClass('error');
                    return false;
                }

                if ( argumentsEditor != null){
                    argumentsEditor.sync();
                }
                $(form).ajaxSubmit(function (data) {
                    var status = data.status;
                    var info = data.info;

                    if (status){
                        alert("插入成功");
                        location.href="__APP__/Admin/Product/";
                    }else{
                        alert(data.info);
                    }

                });
            }
        });


        $('#reset_btn').click(function () {
            contentEditor.setContent('');
            if ( argumentsEditor != null){
                argumentsEditor.setContent('')
            };
            validator.resetForm();
            $('.valid').removeClass('valid');
            $('.error').removeClass('error');
            datepicker.new('datepicker');
        })
    });

    function ajaxFileUpload() {
        $.ajaxFileUpload({
            url: '__APP__/Admin/Upload/ajaxUpload',
            secureuri: false,
            fileElementId: 'fileField',
            dataType: 'json',
            complete: function (data, status) {

            },
            success: function (data, status) {

                var Imgid = rand(100);

                var imageSpan = "<span style='left:10px;'>" +
                        "<span style='position: relative;top: -50px;'>"+
                        "<a href='javascript:void(0);' id='delimg_"+Imgid+"' class='delImage'>X</a>"+
                        "</span>"+
                        "<img id="+Imgid+" class=\"preview-img\" src=\"" + '__APP__' + data.info[0].savepath + 'thumb_' + data.info[0].savename + "\" style=\" width:150px; \">"+
                        "</span>";
                var url =    data.info[0].savepath + 'thumb_' + data.info[0].savename;
                $('#picture').val(url);
                $('#product_image').append(imageSpan);
//                $('#product_image').append("<img class=\"preview-img\" src=\"" + '__APP__' + data.info[0].savepath + 'thumb_' + data.info[0].savename + "\" style=\" width:150px; \">");
            },
            error: function (data, status, e) {
                alert("上传失败");
            }
        })
        return false;
    }

    function ajaxFileUploadAttachment() {
        $.ajaxFileUpload({
            url: '__APP__/Admin/Upload/ajaxUploadAttachment',
            secureuri: false,
            fileElementId: 'attachment',
            dataType: 'json',
            complete: function (data, status) {
                alert('已上传');
            },
            success: function (data, status) {
                $('#attachment_url').html("<p>"+data.info[0].savename+"</p>");
                $('#attachment_hidden').val(data.info[0].savename);
            },
            error: function (data, status, e) {
                alert("上传失败");
            }
        })
        return false;
    }




    rnd.today=new Date();
    rnd.seed=rnd.today.getTime();
    function rnd(){
        rnd.seed = (rnd.seed*9301+49297) % 233280;
        return rnd.seed/(233280.0);
    };
    function rand(number){
        return Math.ceil(rnd()*number);
    };

</script>

<div id="dialog-div" style="display:none">
</div>
</body>
</html>
